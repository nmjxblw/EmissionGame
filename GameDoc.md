# 文档

## 设计

- 游戏类型（为什么挑选这个类型？）
  - 三消（规则简单，容易上手，容易进行规则拓展）
  - 卡牌构筑
    - 1.市场验证过的可行玩法。
    - 2.玩家研究卡牌构，将构建发布到游戏社区，形成一种积极的讨论氛围。
      - 提高游戏深度和话题度。（理想结果）
- 游戏受众
  - 学生
  - 工薪层
  - 希望利用碎片化时间玩游戏的群体
- 游戏时长
  - 长周期培养角色（如果项目商业化）
  - 单局对战时间少于3分钟（为什么这么设计？理想的碎片化时长）
    - 在尽可能短的时间内让玩家获得反馈，以提高用户粘性。
      - 正反馈，觉得有意思（怎么提高？++）
      - 负反馈，有挫败感（怎么减少？--）
    - 容易把控游戏节奏感
      - 把握游戏时情绪流，从卡组套牌启动、布局的从容到倒计时时斩杀的紧迫感。
      - 根据心流理论，动态调整游戏难度
        - 玩家会因为时间充裕，在前期运营建立对局优势。（easy-平缓）
        - 玩家会因为后期时间紧迫而犯错误，导致局优势反转。（hard-紧张）
- 商业模式

- 付费意向（如果项目商业化）

## 实现

- 创建网页三消小游戏，屏幕比例9：16，随窗口大小自适应放缩。
- 美术风格以像素风为主。使用svg绘制并管理动画。
- 屏幕内画布背景颜色为黑色，画布外的背景不渲染。
- 输出格式为index.html脚本，使用原生html+css+javascript实现。
- 代码需要注释，包含变量注释、函数注释。
- 变量命名采用驼峰命名规范，禁止使用缩写。
- 点击屏幕进入整备场景。
  - 从local storage中读取玩家队伍配置。如果没有则使用随机配置。
  - 玩家在队伍配置界面选择关卡敌人以及队伍配置。
  - 在整备场景提供配置保存选项，将玩家配置序列化，并存储于local storage中。玩家关闭页面时，检测配置合法性，如果合法则自动保存配置。
  - 合法性：
    - 每当棋子库的数量发生变化时进行合法性检测。
    - 玩家队伍由3位不重名角色构成，棋子库由角色行动构成，每个不同的角色有4种行动。
    - 玩家构筑棋子库时，需放置8种不同行动，行动棋子只能来源于队伍构筑中的三个角色。棋子库少于8种不同行动时或棋子库大于等于8种时锁定保存队伍配置功能，大于等于8时不允许玩家添加棋子。
    - 每个角色至少添加1种行动到棋子库，条件不满足则锁定保存配置功能。
  - 每个角色有固有战斗数值属性，这些数值属性在战斗开始时从静态文件中读取：
    - 生命上限
      - 角色进入战斗时生命值设置为与生命上限相同。
      - 当生命值变为{0}时，角色陷入昏迷状态。
      - 队伍中所有角色陷入昏迷状态，则挑战失败。
    - 基础攻击力
    - 基础防御力
    - 属性
      - 共有5种不同的属性，2种相克图。
      - 火属性
        - 克制叶属性，被水属性克制
      - 水属性
        - 克制火属性，被叶属性克制
      - 叶属性
        - 克制水属性，被火属性克制
      - 光属性
        - 克制暗属性，被暗属性克制
      - 暗属性
        - 克制光属性，被光属性克制
    - 破绽
      - 每个角色都有1个或者多个属性破绽。
      - 每个破绽计数器单独结算。
      - 每次角色受到对应的属性伤害，对应的属性破绽计数器会减少相应的数值。当破绽计数器为0或更低时，角色受到一次同属性固定追加伤害并重置该计数器，该伤害不会触发破绽计数器。
      - 破绽伤害伤害初始为固定值，受角色技能或者游戏机制动态变化。
      - 破绽伤害可以被护盾值抵消。
    - 苏醒值
      - 战斗中，在角色陷入昏迷状态后，若队伍种仍有角色生命值不为{0}。则昏迷角色的行动转化为该角色的“苏醒”行动。
      - 在累计消除固定次数的“苏醒”行动后，角色苏醒，并将生命值重置为半满状态。
      - 每个角色每场战斗最多苏醒{3}次，在苏醒次数消耗完以后。“苏醒”行动不再唤醒昏迷的角色。
    - 速度
      - 战斗中，速度表现形式为单位时间内角色可行动的次数。每个角色的行动次数分别计算。
      - 速度受角色技能和增益影响。
      - 角色速度下限为{1}，上限为{100}.
      - $$
          当前角色相对行动次数 = \frac{当前角色速度}{当前最慢角色的速度}
        $$
  - 每个角色有临时数值属性，这些属性会在战斗之后移除：
    - 临时生命上限
    - 临时攻击力
    - 临时攻击力加成
    - 临时防御力
    - 临时防御力加成
    - 护盾量
      - 可叠加。
      - 在伤害结算时，每{1}点护盾可以抵消{1}点非真实伤害。
      - 真实伤害不会被护盾抵消。
    - 角色特有的充能
    - 临时速度
  - 对战计算公式
    - 伤害公式对敌人和玩家都有效：$$单次造成伤害 = \max(1,\min(\lfloor \frac{1}{5}\times （目标基础生命上限+临时生命上限） \rfloor,\lfloor \frac{（角色基础攻击力 + 临时攻击力）\times （1+临时攻击力加成）\times 伤害修正因数}{（目标基础攻击力 + 临时防御力） \times  （1+临时防御力加成）+ 伤害修正因数} \times （1+临时总伤害加成）\rfloor))$$
      - 说明：单次伤害不能超过目标现有生命上限的20%，防止伤害溢出。单次伤害最少为
    - 伤害修正因数对敌人和玩家都生效，计算公式： $$ 伤害修正因数 = 5 \times （1+关卡难度等级系数） $$
    - 护盾
    - 临时攻击加成
    - 临时防御加成
  - 角色设计思路/机制
    - 定位
      - 主力输出位
        - 无属性伤害
          - 无属性克制和加成关系的伤害。
        - 属性伤害
          - 需要考虑属性免疫、属性加成以及属性克制关系的伤害。
        - 真实伤害
          - 无视护盾的伤害。不会触发被攻击角色的护盾机制。
        - 属性真实伤害
          - 仅对指定属性护盾无效。
          - 不会触发被攻击角色的其他属性护盾机制。
          - 如果被攻击角色没有指定属性的护盾，则作为属性伤害处理。
        - 护盾伤害
          - 仅对护盾有效的伤害。不会对角色生命值造成影响。
        - 混合属性伤害
          - 单次伤害中混合2种或以上的属性伤害。每种伤害分别考虑伤害机制。
        - 延迟伤害
          - 不会在行动触发时生效的伤害。有特殊的触发扳机。
          - 例如：中毒
        - 爆发伤害
          - 通常指单次行动造成大量伤害，但伤害频率相对较低的行动。
        - 持续伤害
          - 通常指伤害频率较为频繁的行动，造成的伤害更加稳定。
          - 速度快，行动频率高，但是伤害较低。
      - 次要输出位
        - 追击伤害
          - 在特定条件下触发的伤害。通常是其他角色行动后，另一位角色额外造成伤害。
        - 特化伤害
          - 仅对某一种类型的敌人造成伤害。通常来说该角色不是主流的主流输出位，但在一定条件下，该角色的输出能力远大于主流输出位。
      - 辅助
        - 增伤
          - 使角色造成的伤害更高。
        - 嘲讽
          - 使敌方角色优先攻击该角色。
        - 护盾
          - 拥有护盾的角色在受到伤害时，优先扣除护盾值，之后再结算受到的伤害。
          - 真实伤害不会触发护盾机制。
        - 属性护盾
          - 泛用性较弱的护盾，仅对指定属性伤害触发抵消效果，对其他属性或者无属性伤害无效。
          - 每种属性伤害独立结算。
        - 沉默
          - 被沉默的角色跳过下一次的行动并移除{1}层“沉默”，直到所有“沉默”被移除角色才能行动。
    - 其他
      - 特殊增益
        - 每个角色的特殊增益可能重复，也可能存在差异。
        - 通常来说特殊增益是对战中的一种临时资源。这些增益会对对战战局产生影响。
        - 一些角色的机制与特殊增益强关联，如果玩家没有合理分配特殊增益资源，那么角色能力将无法正常发挥。
      - 同名效果
        - 以每个效果的ID为准，相同的效果ID视为同名效果。
        - 通常来说，结算效果时，存在嵌套触发关系，需要使用ID来作为区分，避免重复触发效果，或者嵌套触发效果而导致死循环。
  
  - 可选角色
    - 测试假人
      - 生命上限：10
      - 角色属性
        - 火属性
        - 水属性
        - 叶属性
      - 破绽
        - 无属性
          - 计数：99
          - 伤害：1
      - 速度：10
      - 被动技能
        - 核心护盾：测试假人由魔晶核心驱动。测试假人每造成{3}次属性伤害，在伤害结算后，魔晶核心会使测试假人获得{3}点护盾。同名效果不能叠加。
      - 主动技能
        - 行动1：指令：炎
          - 单消：测试假人对目标造成{1}点火属性伤害。
          - 三消：测试假人对目标造成{2}点火属性伤害。
        - 行动2：指令：流
          - 单消：测试假人对目标造成{1}点水属性伤害。
          - 三消：测试假人对目标造成{2}点水属性伤害。
        - 行动3：指令：茂
          - 单消：测试假人对目标造成{1}点叶属性伤害。
          - 三消：测试假人对目标造成{2}点叶属性伤害。
        - 行动4：指令：盾
          - 单消：测试假人获得{1}点护盾。
          - 三消：测试假人获得{3}点护盾，每额外消除一个“指令：盾”行动，获得的护盾点数+{1}。

    - 阿波罗的伪造神像
      - 生命上限：10
      - 角色属性
        - 光属性
      - 破绽
        - 暗属性
          - 计数：99
          - 伤害：1
      - 速度：10
      - 被动技能
        - 光能庇护： 阿波罗的伪造神像蕴含圣神祝福。阿波罗的伪造神像每造成{4}次光属性伤害，在伤害结算后，祝福会使阿波罗的伪造神像会获得{4}点护盾。同名效果不能叠加。
      - 特殊增益
        - 闪锋：最大叠加{3}层。在友方单位造成单次光属性伤害时触发，移除1层“闪锋”。在伤害结算前，阿波罗的伪造神像同时对目标角色造成{1}点光属性伤害。该伤害不会触发“闪锋”，且同名效果不能叠加。
      - 主动技能
        - 行动1：祝福：初芒
          - 单消：阿波罗的伪造神像对目标造成{1}点光属性伤害。
          - 三消：阿波罗的伪造神像对目标造成{2}点光属性伤害。
        - 行动2：祝福：闪锋
          - 单消：阿波罗的伪造神像获得{2}层“闪锋”。
          - 三消：阿波罗的伪造神像获得{3}层“闪锋”，每额外消除一个“祝福：闪锋”行动，阿波罗的伪造神像还会获得{1}点护盾。
        - 行动3：祝福：沐光
          - 单消：阿波罗的伪造神像将{2}点护盾随机分配给所有友方角色。
          - 三消：阿波罗的伪造神像使得一个指定的的友方角色获得{3}点护盾。每额外消除一个“祝福：沐光”行动，获得的护盾点数+{1}。
        - 行动4：祝福：烈阳
          - 单消：阿波罗的伪造神像对目标造成{2}点光属性伤害。本次伤害不会触发“闪锋”。
          - 三消：阿波罗的伪造神像对随机敌方单位造成{1}点光属性伤害，重复{3}次。

    - 哈迪斯的仿造雕塑
      - 生命上限：10
      - 角色属性
        - 暗属性
      - 破绽
        - 光属性
          - 计数：99
          - 伤害：1
      - 速度：10
      - 被动技能
        - 冥神的余威：哈迪斯的仿造雕塑蕴含来自冥界的力量，每当哈迪斯的仿造雕塑对其他角色造成了暗属性伤害，哈迪斯的仿造雕像会对该角色施加{1}层“余威”。同名效果不能叠加。
      - 特殊增益
        - 余威：最大叠加{3}层。在一个角色在获得{3}层“余威”后触发，移除该角色身上所有“余威”，哈迪斯的仿造雕塑对该角色造成{1}点暗属性伤害。该伤害不会触发“冥神的余威”。
      - 主动技能
        - 行动1：神威：言
          - 单消：哈迪斯的仿造雕塑对目标造成{1}点暗属性伤害。
          - 三消：哈迪斯的仿造雕塑对目标造成{2}点暗属性伤害。
        - 行动2：神威：噤
          - 单消：哈迪斯的仿造雕塑使目标获得{1}层沉默。
          - 三消：哈迪斯的仿造雕塑使目标获得{2}层沉默
        - 行动3：神威：怖
          - 单消：哈迪斯的仿造雕塑对目标造成{1}点无属性伤害。
          - 三消：哈迪斯的仿造雕塑对目标造成{1}点无属性伤害。移除目标身上所有“余威”，每消除{1}层“余威”，哈迪斯的仿造雕塑使目标获得{1}层沉默。
        - 行动4：神威：厉
          - 单消：哈迪斯的仿造雕塑对目标造成{2}点暗属性伤害。移除目标身上所有“余威”。该伤害不会触发“冥神的余威”。
          - 三消：哈迪斯的仿造雕塑对目标造成{2}点暗属性伤害。移除目标身上所有“余威”，每消除{1}层“余威”，哈迪斯的仿造雕塑对目标额外造成{1}点暗属性伤害。该伤害不会触发“冥神的余威”。

    - 凯
      - 生命上限：10
      - 角色属性
        - 火属性
      - 破绽
        - 水属性
          - 计数：10
          - 伤害：2
      - 被动技能
        - 火魔眼：凯的炎魔灵视能够看到敌人身上的灼痛之伤，在“火魔眼”状态下，凯造成火属性伤害时额外造成1点火属性伤害，然后移除“火魔眼”状态。同名效果不能叠加。
      - 特殊增益
        - 锋芒：凯的利刃准备出鞘，最多叠加3层。
      - 主动技能
        - 行动1：斩
          - 单消：凯获得1层“锋芒”，并对指定1名角色造成{1}点无属性伤害。
          - 三消：如果凯已经拥有3层“锋芒”，那么移除凯的所有“锋芒”，对所有敌人造成1点无属性伤害。否则，凯获得3层“锋芒”。
        - 行动2：御
          - 单消：凯消耗1层“锋芒”，使得凯获得{3}点护盾。
          - 三消：凯触发一次不消耗“锋芒”的单消“御”。此外，凯还会获得1层“锋芒”。
        - 行动3：征
          - 单消：凯获得2层“锋芒”。
          - 三消：凯获得3层“锋芒”，且下一次行动不会消耗“锋芒”。
        - 行动4：霸
          - 单消：凯消耗1层“锋芒”，将随机4个凯的非“霸”行动转化为“霸”行动。如果“锋芒”层数小于1层，则改为随机2个。
          - 三消：消耗3层“锋芒”，对一个角色造成1点火属性伤害，重复3次。每额外消除一个“火-霸”行动，重复次数+1。如果“锋芒”层数不足3层，则移除所有“锋芒”，改为造成2点火属性伤害。

    - 娑莎
      - 生命上限：10
      - 角色属性
        - 叶属性
      - 破绽
        - 火属性
          - 计数：10
          - 伤害：2
      - 被动技能
        - 夜莺的青枝：娑莎曾受到过夜鸟的祝福。她的歌喉能够抚平友人心灵的创伤。在娑莎行动结束后，每层“夜律”会随机治疗一个受伤的友方单位1点生命值。然后移除所有“夜律”。
      - 特殊增益
        - 夜律：娑莎的歌喉宛如夜莺，最多叠加10层。
      - 主动技能
        - 行动1：月夜吟颂
          - 单消：娑莎获得{1}层“夜律”。
          - 三消：娑莎获得{2}层“夜律”。每额外消除一个“月夜吟”行动，额外获得{1}层夜律。
        - 行动2：花蔓之殇
          - 单消：娑莎对一个敌方角色造成{1}点叶属性真实伤害。
          - 三消：娑莎对一个敌方角色造成{1}点叶属性真实伤害，重复{2}次。每额外消除一个“花蔓之殇”行动，重复次数+{1}。
        - 行动3：湖中香涟
          - 单消：娑莎使一个友方角色获得{2}点护盾。
          - 三消：娑莎使一个友方角色获得{3}点护盾。如果额外消除{2}个“湖中香涟”行动，还会使娑莎当前的“夜律”层数翻倍。
        - 行动4：青鸟之怒
          - 单消：娑莎对一个敌方角色造成{1}点无属性伤害，重复{1}次。移除所有“夜律”，每移除{1}层夜律，重复次数+{1}。
          - 三消：娑莎对一个敌方角色造成{1}点无属性伤害，重复{2}次。移除所有“夜律”，每移除{1}层夜律，重复次数+{1}。每额外消除一个“青鸟之怒”行动，重复次数+{1}。

    - 阿雅
      - 生命上限：10
      - 角色属性
        - 水属性
      - 破绽
        - 叶属性
          - 计数：10
          - 伤害：2
      - 被动技能
        - 洞悉真言：阿雅受过水神阿库娅的祝福，她的言语能穿透肉身，直击灵魂。阿雅每{3}次行动结束后，阿雅将随机{2}个水属性行动附魔“真言”。
      - 特殊增益
        - 真言：拥有“真言”附魔的行动被消除时，阿雅对所有敌方单位造成{1}点水属性真实伤害。
        - 寒雨：最大叠加{99}层。在角色行动结束后，阿雅对拥有“寒雨”的角色造成{1}点护盾伤害，每有{1}层“寒雨”，造成的伤害+{1}。移除{1}层“寒雨”。
        - 战刃形态：阿雅进入战刃形态，技能得到强化。在{3}个行动结束后，切换为“常态”。
        - 长弓形态：阿雅进入长弓形态，技能得到强化。在{3}个行动结束后，切换为“常态”。
      - 主动技能
        - 行动1：附魔水刃
          - 单消：如果阿雅没有进入“战刃形态”，则将阿雅切换为“战刃形态”。战刃形态：阿雅对敌方1号位角色造成{1}点水属性伤害，重复{2}次。
          - 三消：阿雅对敌方1号位角色造成{1}点水属性伤害，重复{2}次。战刃形态：阿雅随机敌方角色造成{3}点水属性伤害，重复{2}次。
        - 行动2：流星水矢
          - 单消：如果阿雅没有进入“长弓形态”，则将阿雅切换为“长弓形态”。长弓形态：阿雅对敌方3号位角色造成{1}点水属性伤害，重复{2}次。
          - 三消：阿雅对敌方3号位角色造成{1}点水属性伤害，重复{2}次。长弓形态：阿雅随机敌方角色造成{1}点水属性伤害，重复{6}次。
        - 行动3：寒雨季
          - 单消：阿雅使一个角色获得{1}层“寒雨”。
          - 三消：阿雅使一个角色获得{2}层“寒雨”。如果本次行动还附带“真言”附魔，阿雅还会使目标角色身上的“寒雨”层数翻倍。
        - 行动4：冰浪猎人
          - 单消：阿雅使一个敌方角色获得{1}层“寒雨”。战刃形态：阿雅还会对该角色造成{2}点水属性伤害。长弓形态：阿雅还会使该角色额外获得{2}层“寒雨”，并造成{1}点水属性伤害。
          - 三消：阿雅对一个拥有护盾的敌人造成{1}点护盾伤害，每消除一个“冰浪猎人”行动，重复{1}次。如果本次行动还附带“真言”附魔，改为造成水属性真实伤害。战刃形态/长弓形态：阿雅还会使该角色额外获得{2}层“寒雨”。
  
  - 非可控角色
  - 非可控角色由游戏内通用AI控制，根据角色描述规则，在角色行动时触发对应的行动。
    - AI逻辑
      - 对战开始时生成行动选取池。
      - 每次行动时，先检测行动合法性，将合法的行动加入行动池，不合法的行动移除或者权重降为0。
      - 根据规则选择必须执行的行动。
      - 否则随机选择行动。
      - 完成选择并执行行动。
    - 测试Boss人偶
      - AI行动规则
        - 测试Boss人偶行动时，从行动池中随机抽取一个行动执行。
        - AI行动选取权重根据血量动态变化
          - 在血量高于65点时，AI不会选取行动4（湮灭）作为当前行动。每个行动的选择权重为{行动1：行动2：行动3 = 4：3：3}.
          - 在血量小于等于65点时，AI解锁行动4（湮灭），选择权重设置为0。测试Boss人偶每行动{3}次，第四次行动必定为行动4（湮灭）。
          - 敌方队伍中存在空位时，AI才会解锁行动5（召唤手下），每个行动的选择权重为{行动1：行动2：行动3：行动5 = 4：2：2：2}.
      - 生命上限：100
      - 角色属性
        - 暗属性
      - 破绽
        - 光属性
          - 计数：10
          - 伤害：2
        - 火属性
          - 计数：20
          - 伤害：2
      - 被动技能
        - 无
      - 主动技能
        - 行动1：暗之利刃
          - 攻击随机一名玩家角色，造成其最大生命值{1/5}的暗属性真实伤害，造成伤害向下取整。
        - 行动2：恶之波动
          - 攻击所有玩家角色，对他们造成2点暗属性伤害。
        - 行动3：暗流涌动
          - 攻击玩家1号位角色，对其造成2点护盾伤害和2点暗属性伤害。
        - 行动4：湮灭
          - 攻击所有玩家角色，对他们造成2点护盾伤害和2点暗属性伤害。
        - 行动5：召唤手下
          - 测试Boss人偶会召唤{1}个测试杂兵人偶在1号位或者3号位的空位上。

    - 测试杂兵人偶
      - AI行动规则
        - 该单位只有一个行动规则
      - 生命上限：10
      - 角色属性
        - 暗属性
      - 破绽
        - 光属性
          - 计数：10
          - 伤害：2
      - 被动技能
        - 无
      - 主动技能
        - 行动1：暗之利刃
          - 攻击随机一名玩家角色，造成其最大生命值{1/5}的暗属性真实伤害，造成伤害向下取整。
        - 行动2：恶之波动
          - 攻击所有玩家角色，对他们造成2点暗属性伤害。
        - 行动3：暗流涌动
          - 攻击玩家1号位角色，对其造成2点护盾伤害和2点暗属性伤害。
        - 行动4：湮灭
          - 攻击所有玩家角色，对他们造成2点护盾伤害和2点暗属性伤害。

- 战斗场景：分为UI、战场以及棋盘三个部分。
  - 战场位于屏幕上半部分，锚点为画布正上方居中位置。
    - 该区域显示战斗动画和角色站位。
    - 玩家阵营在战场左下角，侧身面对屏幕。
    - 敌方阵营在战场右上角。正对屏幕。
  - UI
    - 棋盘上方居中摆放玩家队伍的角色头像UI，
    - 显示当前角色的HP条状图和数值。
    - HP条下方显示当前的增益效果和状态。
    - 角色昏迷时，头像UI改为灰白，血量低于1/10时，UI轮廓显示红色呼吸灯提示，
    - 对于所有UI，需提供悬停显示信息效果。
  - 棋盘
    - 绘制10*10的棋盘（用数组存储）
    - 棋子用1-4罗马数字来表示行动的序号。
    - 颜色规则如下：
      - 火：粉红色，圆角正三角形表示
      - 水：天蓝色，圆形表示
      - 叶：黄绿色，圆角菱形表示
      - 光：淡黄色，圆角正六边形表示
      - 暗：暗紫色，圆角正八边形表示
    - 提高棋子饱和度。
    - 具有特殊增益的棋子，其边框使用荧光高亮表示。
  
  - 消除规则：
    - 当轮到玩家操控的角色行动时，如果棋盘上没有对应角色的行动棋子，则重新生成棋盘，直到有可操作棋子在棋盘上为止。
    - 高亮并将所有当前行动角色的棋子透明度调整为最大，其他非当前操控角色的行动棋子设置为半透明。
    - 除非玩家操作使得行动棋子消除，否则棋盘不发生改变。
    - 如果玩家通过操作或者棋子下落时，使得该角色的行动棋子出现横向或者竖向连续的三个相同的棋子，则消除这些棋子以及它们相邻1格的类型相同的棋子。并触发角色对应技能的消除效果。
    - 玩家也可以通过双击消除单个行动棋子，触发角色对应技能的消除效果。
  - 棋盘上出现消除空缺时，棋子会受重力影响向下填充空缺，最上方的棋子空缺则随机生成。棋盘锚点固定为屏幕的底端居中位置。
